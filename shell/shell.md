# 基礎
## 概要
- コマンドを実行する = 新しいプロセスが起動する
- やっていること
  - 文字列をトークンに分解(スペースやクォーテーション当の処理)
  - 変数の展開
  - リダイレクト(FDの処理)
  - 内部コマンド(builtin)の処理
  - 外部プログラムの起動

## 設定の読み込み
#### ログインシェル
- SSHログイン等
- 以下を読み込む
  - `/etc/profile`
  - 以下のいずれか
    - `~/.bash_profile`
    - `~/.bash_login`
    - `~/.profile`
- 大体の場合、上記のファイルで`~/.bashrc`も`source`する設定になっている
#### 対話シェル
- GUIでbashを起動、dockerで起動等
- `~/.bashrc`を読み込む
#### 後から定義
- `Dockerfile`, `compose.yml`等で起動時に定義する

#### まとめ
| 起動形態 | 典型例 | bashが自動で読む |
|---|---|---|
| ログイン + 対話 | SSHログイン / su - / bash --login | /etc/profile → ~/.bash_profile or ~/.bash_login or ~/.profile（最初の1つ） |
| 非ログイン + 対話 | 端末で bash / docker exec -it ... bash | ~/.bashrc |
| 非対話 | bash -c / シェルスクリプト | （通常は読まない）BASH_ENV があればそれを source |

## コマンド
### 内部コマンド
| 種別 | コマンド例 | 何をするか（事実ベースの要点） |
|---|---|---|
| 変数/環境 | export | 変数を「環境」に出して子プロセスへ渡せるようにする |
| 変数/環境 | unset | シェル変数/環境変数を削除する |
| ディレクトリ | cd | シェル自身のカレントディレクトリを変更する |
| 文字列/出力 | echo | 引数を出力する（実装依存の挙動もあるので注意） |
| 文字列/出力 | printf | 書式指定で出力する |
| 情報 | type | コマンド名が builtin/外部/関数/alias どれか表示する |
| 情報 | command | 予約語/alias等の影響を抑えて実行・情報表示する用途がある |
| 制御 | exit | シェルを終了する |
| 制御 | return | 関数/スクリプトの戻りとして使う（文脈依存） |
| 条件 | test / [ | 条件判定を行う（ファイル/文字列/数値） |
| ジョブ | jobs | ジョブ一覧を表示する（端末に紐づく制御） |
| ジョブ | fg / bg | ジョブを前面/背面へ |
| 端末入力 | read | 標準入力から読み取り、変数へ格納する |
| 位置引数 | shift | $1,$2… をずらす |
| シェル動作 | source / . | 現在のシェルでファイルを読み込んで実行する |

### FD
| FD番号 | 通称 | 典型的な接続先 | どうやって決まるか |
|---:|---|---|---|
| 0 | stdin (標準入力) | 端末・パイプ・ファイル | 親プロセス（多くはシェル）が起動時に接続を用意（リダイレクトで変更可） |
| 1 | stdout (標準出力) | 端末・パイプ・ファイル | 同上 |
| 2 | stderr (標準エラー) | 端末・パイプ・ファイル | 同上 |

| 書き方 | 意味（シェルの解釈） | 対象FD |
|---|---|---:|
| cmd < in.txt | 標準入力を in.txt から読む | 0 |
| cmd > out.txt | 標準出力を out.txt に上書き出力 | 1 |
| cmd >> out.txt | 標準出力を out.txt に追記出力 | 1 |
| cmd 2> err.txt | 標準エラーを err.txt に上書き出力 | 2 |
| cmd 2>> err.txt | 標準エラーを err.txt に追記出力 | 2 |
| cmd > out.txt 2> err.txt | stdout と stderr を別々に出す | 1 と 2 |
| cmd > all.txt 2>&1 | stderr(2) を stdout(1) と同じ先にする | 2 → 1 |
| cmd 1> out.txt | 「>」の省略形を明示（stdout） | 1 |
| cmd 0< in.txt | 「<」の省略形を明示（stdin） | 0 |

### コマンド解決
- 確認要素
  - alias
  - function
  - 内部コマンド
  - 外部コマンド

## 権限
### 概要, 設計思想
- subject + objectの組み合わせで、実行可能かどうかを管理する
- デフォルトで拒否、明示で許可
- 各要素によって何をsubjectとするか、objectとするかが変わる

### 権限の概念がある要素
| 分類      | subject（例）              | object（例）                        | 主に関与する仕組み（代表）                          |
| ------- | ----------------------- | -------------------------------- | -------------------------------------- |
| ファイル    | プロセス（実行ユーザー/EUID・グループ）  | ファイル / ディレクトリ                    | DAC / ACL /（環境によりMAC）                  |
| デバイス    | プロセス（EUID等）             | デバイスファイル（/dev/*）                 | DAC / ACL                              |
| ソケット    | プロセス（クライアント側）           | Unix domain socket のパス（ソケットファイル） | DAC / ACL（接続や送受信に絡む）                   |
| プロセス    | プロセスA（送信側）              | プロセスB（対象PID）, file, etc...                   | UID/GID規則 + capabilities + 各種設定 +（MAC） |
| ネットワーク  | プロセス（サーバ/クライアント）        | ネットワーク資源（ポート、IF設定、ルーティング等）       | capabilities（例: CAP_NET_BIND_SERVICE）等 |
| IPC     | プロセス（作成/接続/操作する側）       | IPCオブジェクト（SysV shm/sem/msg など）   | IPC固有permission + UID/GID              |
| 管理系     | 管理操作を行うプロセス（ユーザー/セッション） | 管理対象（systemdユニット/サービス等）          | root権限 +（polkit等が絡む場合）                 |
| セキュリティ層 | プロセス（ラベル付きsubject）      | ラベル付きobject（ファイル/プロセス/ポート等）      | MAC（追加制約）                              |


# プロセス
## 構成要素
| 構成要素 | 具体例 | 何のためにあるか（事実としての役割） |
|---|---|---|
| 識別子 | PID / PPID | 自分と親を識別する |
| 実行内容 | 実行ファイル、命令ポインタ等 | 何をどこまで実行しているか |
| メモリ空間 | コード/データ/ヒープ/スタック | プログラムの状態を保持する |
| レジスタ/コンテキスト | CPUレジスタ類 | スケジューリングで中断・再開するために必要 |
| 環境 | env（PATH等） | 実行時設定を子へ渡すためのキー値集合 |
| 作業ディレクトリ | cwd | 相対パス解決の基準 |
| FD表 | 0,1,2や開いたファイル/ソケット | 入出力・通信の口 |
| 権限 | UID/GID、実効ID等 | アクセス制御（何ができるか） |
| 状態 | R/S/D/T/Z 等 | 実行中/待ち/停止/終了後回収待ち等 |
| シグナル関連 | マスク/ハンドラ | 外部からの通知・介入をどう扱うか |
| （必要に応じて）スレッド | 複数スレッド | 同一プロセス内で並行実行する単位 |

## 親子
- プロセスが別プロセスを起動する際、親子関係が結ばれる
- 親プロセスの環境変数のコピー, FD, cwd等が引き継がれる
- その他も含めてのまとめ

| 観点 | 親子（直接） | 無関係（直接親子でない） |
|---|---|---|
| 環境変数 | 親→子へ起動時にコピー継承される | 共有されない（別プロセスの環境） |
| FD（0/1/2など） | 親が用意した接続状態を子が引き継ぐのが典型 | 共有されない（ただし別の仕組みで同じファイルを開くことはある） |
| 終了ステータス回収 | 親が wait で回収できる | 原則できない |
| ゾンビ回収責任 | 親に回収責任がある（waitしないとゾンビが残り得る） | 直接責任はない |
| 管理のしやすさ | 起動者なのでPIDを把握しやすい | PID探索が必要になりがち |

## 権限
### 概要
- プロセスが、他プロセスやファイルなど、他の要素にどこまで干渉できるかを管理
- プロセスの実行元を明示化

### sudo
- sudoプロセスがrootとして起動
- 指定コマンドをroot権限で実行

## ライフサイクル
### state
| 表記例 | 意味（典型） | 何が起きている系か |
|---|---|---|
| R | 実行中 | CPU上で動いている/実行可能 |
| S | 割り込み可能スリープ | 何か待ち（I/Oやイベント待ち等） |
| D | 割り込み不可能スリープ | 主にI/O待ち等で割り込みに反応しにくい状態 |
| T | 停止 | ジョブ制御やデバッガ等で停止 |
| Z | ゾンビ | 終了済みだが親がwaitで回収していない |

### 状態管理や介入
| 目的 | 代表コマンド例 | 何をしているか（事実ベース） |
|---|---|---|
| 一覧を見る | ps, pstree | プロセス情報を表示する |
| 動的に監視 | top, htop | 使用率や状態を継続表示する |
| PIDを探す | pgrep, pidof | 条件に合うPIDを探す |
| 終了要求 | kill -TERM <pid> | SIGTERM を送る（終了を依頼） |
| 強制終了 | kill -KILL <pid> | SIGKILL を送る（強制終了） |
| 停止/再開 | kill -STOP / -CONT | 停止・再開のシグナルを送る |
| 優先度変更 | nice, renice | スケジューリング優先度（nice値）を変える |
| ジョブ制御 | jobs, fg, bg | 端末に紐づくジョブを操作する |
| FDや環境を見る | /proc/<pid>/fd, /proc/<pid>/environ | プロセスの資源を参照（権限が必要） |

## 変数
- シェル変数: bash自身が持つ変数
- 環境変数: プロセスに保持される変数
- `export`されるシェル変数は、そのシェルから起動したプロセスの環境変数としてコピーして定義される


# ファイル/ディレクトリ
## 権限
### 概要
- subject(user)がobject(file, dirctory)に対して、permission(rwx)の内何をできるかを管理
### subject/permisson
- subject
  - owner
  - group
  - others
- permisson
  - r read
  - w write
  - x execute
  - deleteはw+x

### 確認(ls -l)
```bash
-rwxr-x--- 1 owner_name group_name 120 Dec 15 10:00 hello.sh
```
- 先頭の2~10文字目: 3つ区切りで、「owner, group, others」それぞれがrwxが可能か
- その次のハードリンク数の次に、owner, groupのそれぞれの名前

### 変更(chmod)
```bash
chmod 755 test.txt
chmod <owner><group><others> file_or_dir
```
- 数値は[r:4, w:2, x:1]の合計値

## ファイルの実行
### 実行方法
| 分類 | 入力例 | PATHを使う？ | 何が起きるか（事実） |
|---|---|---|---|
| PATH探索で実行 | rails / ls / ruby | 使う | PATH内のディレクトリを順に探し、見つかった実行ファイルを起動 |
| 絶対パス実行 | /usr/bin/ls | 使わない | 指定パスのファイルを直接起動 |
| 相対パス実行 | ./script / ../bin/tool | 使わない | 現在のcwdからの相対位置のファイルを直接起動 |
| cwdをPATHに含めて実行 | mytool（PATHに`.`や空要素がある） | 使う | PATHにカレントディレクトリが含まれていればそこで見つかることがある |
| インタプリタを明示して実行 | ruby script.rb / bash script.sh | PATH（インタプリタ側） | まず ruby/bash を実行 → その引数として script を解釈して実行 |
| shebangで実行 | ./script.rb（先頭が#!） | PATH（env方式のみ） | OSが#!を見て指定インタプリタを起動し、スクリプトを渡す |
| env経由shebang | #!/usr/bin/env ruby | 使う | /usr/bin/env が PATH で ruby を解決して起動 |
| source（現在のシェルで実行） | . ./env.sh / source file | 使わない | 新プロセスを作らず、現在のシェルに読み込んで実行（環境が“残る”） |
| exec（シェルを置き換え） | exec cmd | cmd次第 | 新プロセスを増やさず、現在のシェルプロセスが cmd に置き換わる |
| シェルを介した実行 | sh -c 'cmd...' / bash -c '...' | cmd次第 | まず sh/bash を起動 → 文字列を解釈して外部コマンドを起動 |

### PATH
#### 概要
- 環境変数の一つ
- 値: ディレクトリのリスト、複数ある場合`:`で区切る
- コマンドを打った時に、どのディレクトリから実行ファイルを探すか決める
- 文末の`:`等、空の要素はカレントディレクトリの意
- 例 `PATH=/usr/local/bin:/usr/bin:/bin`なら以下を順番に探す
  - `/usr/local/bin/対象`
  - `/usr/bin/対象`
  - `/bin/対象`

#### 関連コマンド
| 目的 | コマンド例 | 何が見えるか |
|---|---|---|
| PATHの表示 | echo "$PATH" | 現在のシェルのPATH文字列 |
| PATHだけ表示 | printenv PATH | 現在プロセスの環境変数PATH |
| 環境変数一覧 | env | 現在プロセスの環境変数一覧 |
| export状況 | export -p | bashがexport対象としている一覧 |
| コマンド解決の確認 | type -a rails | alias/function/builtin/外部の候補を表示 |
| PATH検索での場所 | command -v rails | 実行される解決先（または未解決） |
| PATH検索での場所 | which rails | PATH検索で見つかったパス（※bash内のalias等は見ないことがある） |
| bashのキャッシュ確認/操作 | hash / hash -r | 検索結果のキャッシュ表示・クリア |

#### 設定場所の例
| 種別 | 例 | 何が起きるか |
|---|---|---|
| システム全体 | /etc/environment | ログイン時の環境として設定され得る |
| profile分割 | /etc/profile.d/*.sh | /etc/profile から読まれて PATH を追加することがある |
| bash対話全体 | /etc/bash.bashrc | 対話bashで source されて PATH を触ることがある |
| コンテナ/プロセス環境 | Dockerfile の ENV PATH=... | シェル起動前に「そのプロセスの環境」として PATH が決まる |
| 親プロセス由来 | systemd / display manager / sshd 等 | シェルは親の環境（PATH含む）を受け取って開始する |

### shebang
- 先頭が`#!`で始まる場合、インタプリタで実行される