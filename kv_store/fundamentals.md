# 基礎
## 概要
- key + valueのシンプルなデータベース
- 用途
  - キャッシュ
  - セッション管理
  - リアルアイム通信
  - 設定管理
- 用途に特化したkvストアを選ぶのが大切
  - 使えるデータ型や速度と整合性のバランス等が異なる
- kvストアの種類

| 型         | 保存場所        | 特徴                                      | 代表的な技術          | 主な利用シーン          |
|------------|-----------------|-------------------------------------------|-----------------------|------------------------|
| インメモリ型 | メモリ(RAM)     | 超高速読み書き                            | Redis, Memcached      | キャッシュ、リアルタイム通信 |
| 永続型     | ディスク         | データ永続性が高い                         | RocksDB, LevelDB      | 永続的なデータ保存      |
| 分散型     | 複数サーバー     | 高可用性・整合性                          | etcd, DynamoDB        | 分散システム管理        |
| ハイブリッド型 | メモリ + ディスク | 高速性と永続性を両立                      | Redis (AOF, RDB)      | 両方の特性が必要な場合  |


## 各ストアの特徴
| 技術       | 用途             | 特徴                                    | 主な利用シーン             |
|------------|------------------|-----------------------------------------|--------------------------|
| Redis      | キャッシュ、Pub/Sub | インメモリ、データ型が豊富               | リアルタイム通信、キャッシュ |
| Memcached  | キャッシュ         | 超高速、データ型はシンプル               | シンプルなキャッシュ       |
| etcd       | 設定管理           | 分散システム、高可用性                  | 分散システムの設定や管理   |
| DynamoDB 
※キャッシュのメジャーな二つ比較
| 項目       | Redis                                    | Memcached                     |
|------------|------------------------------------------|-------------------------------|
| データ型   | 文字列、リスト、セット、ハッシュ         | 文字列のみ                    |
| 永続化     | サポートあり                             | サポートなし                  |
| Pub/Sub    | あり                                     | なし                          |
| 複雑性     | 複雑なデータ管理も可                     | シンプルなデータ管理          |
| 用途       | キャッシュ、リアルタイム通信、Pub/Sub    | シンプルなキャッシュ           |

## データ型
### 表

| データ型       | 概要                             | 特徴                                    | 主な用途                | サポートするKVストア   |
|----------------|----------------------------------|-----------------------------------------|-------------------------|------------------------|
| String         | 文字列、数値、JSONを格納。        | 基本的なデータ型。                      | セッションID、JSONデータ | Redis, Memcached       |
| List           | 順序付きリスト。                  | 重複許可。先頭・末尾追加可能。           | チャット履歴、キュー     | Redis                 |
| Set            | 重複しない集合。                  | 要素は一意。順序保証なし。               | タグ管理、ユニークID     | Redis                 |
| Hash           | キーとフィールドのペア。          | 複数のフィールドを持つ。                | ユーザー情報、構造化データ | Redis                 |
| Sorted Set     | スコア付き順序付きセット。        | スコアで並び替え。                      | ランキング、優先順位管理 | Redis                 |
| Bitmap         | ビット演算をサポートするデータ型。 | 特定ビットを0/1で管理。                 | ユーザーの出席管理など | Redis                 |
| HyperLogLog    | ユニークな要素の概数をカウント。  | 正確な数は出せないが高速。              | ユニーク訪問者数のカウント | Redis                 |
| Stream         | 時系列データ管理。                | イベントログやストリームデータ。         | ログ管理、イベント管理 | Redis                 |
| JSON           | JSON形式のデータを格納・操作。    | JSONデータを直接保存・取得。            | 構造化データ、APIレスポンス | Redis (RedisJSON)     |
| Geospatial     | 地理空間データを格納。            | 緯度経度データの管理。                   | 地図情報、距離計算       | Redis                 |

### 使用例
```bash
# List(Que)
LPUSH messages "Hello"
RPUSH messages "World"
LRANGE messages 0 -1

# Sorted Set
ZADD ranking 100 "juna"
ZADD ranking 200 "player"
ZRANGE ranking 0 -1 WITHSCORES
```


## コマンド
| 操作     | 説明                      | 代表的なコマンド           |
|----------|---------------------------|---------------------------|
| 追加     | データを追加する           | SET, HSET, LPUSH          |
| 取得     | データを取得する           | GET, HGET, LRANGE         |
| 削除     | データを削除する           | DEL, HDEL, LREM           |
| 更新     | データを更新する           | SET, HSET, ZADD           |
| 検索     | 特定のデータを検索する     | SCAN, ZRANGE              |
| 有効期限 | キーの有効期限を設定する   | EXPIRE                    |


# キャッシュ戦略
## ワード
- キャッシュヒット: 必要なデータがキャッシュに存在する場合。
- キャッシュミス: 必要なデータがキャッシュに存在しない場合。
## 概要
- キャッシュするデータの選定
- キャッシュデータの保持期間
- 古くなったキャッシュの更新

## キャッシュの選定時の戦略
| 戦略         | 英語名        | 概要                                                       | 特徴                                                    | 欠点                                                      | 用途                             |
|--------------|---------------|------------------------------------------------------------|---------------------------------------------------------|-----------------------------------------------------------|----------------------------------|
| Write-Through | Write-Through | データベースに書き込むと同時にキャッシュにも書き込む。     | 読み取りが高速、データ整合性が保たれやすい               | 書き込み処理が遅くなる可能性あり                         | 読み込み頻度が高いデータ          |
| Write-Back    | Write-Back    | データをまずキャッシュに書き込み、後からデータベースに反映する。 | 書き込みが高速、データベースへの書き込み回数が減る       | キャッシュ消失時に未反映データが失われるリスク           | 頻繁に書き込みが発生するデータ    |
| Cache-Aside   | Lazy Loading  | 必要な時にのみデータベースから取得し、キャッシュに保存する。 | 必要なデータのみキャッシュされる、無駄なデータが残らない | 最初の読み込みが遅くなる                                  | 頻繁に読み書きが発生しないデータ  |
| Read-Through  | Read-Through  | アプリケーションはキャッシュにデータがない場合、自動的にデータベースから取得する。 | データ取得が一貫している、キャッシュ管理が簡単           | 一部のKVストアではサポートされていない                   | 頻繁にアクセスされるデータ        |

## キャッシュのデータ削除戦略(Evictaion Policies)
| ポリシー     | 概要                                        | 用途                       |
|--------------|---------------------------------------------|----------------------------|
| LRU          | 最後に使われた時間が古いデータから削除      | 一般的なキャッシュ戦略     |
| LFU          | 使用頻度が少ないデータから削除             | 頻度に偏りがある場合       |
| FIFO         | 最初に追加されたデータから削除             | データの順序が重要な場合   |
| TTL          | 有効期限が切れたデータを削除               | 時間制限があるデータ       |
| NoEviction   | 削除せずエラーを返す                       | データ損失が許されない場合 |

## キャッシュの有効期限(TTL: Time To Live)
- キーに対しての有効期限を設定する
```bash
SET user:1:session "active"
EXPIRE user:1:session 3600
```

## ポイント
1. キャッシュするデータの選定: 頻繁にアクセスされるデータ。
2. 有効期限の設定: 不要なデータを残さないようにする。
3. エビクションポリシーの選択: 使用ケースに応じて適切なポリシーを選ぶ。
4. ヒット率のモニタリング: 定期的にキャッシュの効果を確認。