# ブラウザのコンポーネント
## 一覧
| 名称           | レイヤー               | 代表的な構成要素                  | 説明                                                                                                                                                                 |
|---------------------------------|-----------------------|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| レンダリングエンジン (Rendering Engine) | 中間レイヤー            | HTMLパーサー, CSSパーサー, レイアウト計算, レンダーツリー, コンポジタ | HTML/CSSを解析し、DOMツリーやCSSOMツリーを生成。<br>これらを基にレイアウト計算を行い、画面に描画するためのレンダーツリーを作成。<br>コンポジタで最終描画処理を行う。                        |
| JavaScriptエンジン (V8エンジンなど)    | 中間～低レイヤー         | ECMAScript, Web APIs, イベントループ | JavaScriptコードをコンパイル・実行するエンジン。<br>ECMAScript仕様を実現し、非同期処理を管理するイベントループや、<br>ブラウザ独自のWeb APIsと連携して動作する。                                  |
| ネットワーキング (Networking)         | 中間～低レイヤー         | HTTPリクエスト, TCP/IP通信, SSL/TLS | HTTPリクエストの送信、レスポンス受信、DNS解決、SSL/TLSハンドシェイクなど、通信関連の全般を担当。<br>ブラウザのネットワーク通信の根幹を支えるモジュール。                                        |
| リソースローダー (Resource Loader)      | 中間レイヤー            | リソース取得, キャッシュ処理          | HTMLを解析して発見した外部リソース（CSS、JavaScript、画像など）を効率的に取得し、<br>必要なエンジンに供給する仕組み。依存関係の解決やキャッシュ処理も行う。                                     |
| データストレージ (Data Storage)        | 中間～低レイヤー         | ローカルストレージ, IndexedDB, Cookie | クライアントサイドでデータを永続化する仕組み。ウェブアプリが状態を保存したり、認証情報を保持するために使われる。<br>IndexedDBは大量データに向く高機能なデータベースAPI。                           |
| ブラウザエンジン (Browser Engine)       | 中間レイヤー            | レンダリングエンジン管理, ネットワーク調整 | 各モジュール（レンダリングエンジン、JavaScriptエンジン、ネットワーキングなど）の統括管理を行い、<br>効率的に連携させる役割を果たす。                                                           |
| サンドボックス (Sandbox)               | 高レイヤー～中間レイヤー  | セキュリティポリシー, メモリ隔離      | 各タブやスクリプトを隔離して実行し、セキュリティを確保する仕組み。<br>クロスオリジン制限（CORS）や、不正なコードからのデータ保護を行う。                                                       |
| プロセスマネージャ (Process Manager)      | 高レイヤー～中間レイヤー  | プロセス分離, タブ間通信            | 各タブを独立したプロセスとして動作させる仕組み。<br>リソース分配やタブ間通信の調整、クラッシュ時の復元も担当する。                                                                         |
| メモリ管理 (Memory Manager)           | 中間～低レイヤー         | ガベージコレクション, ヒープ管理       | JavaScriptエンジンやレンダリングエンジンで利用されるメモリを効率的に管理。<br>特にJavaScriptではガベージコレクションを通じて不要なメモリを解放する仕組みが重要。                                     |
| UIバックエンド (UI Backend)            | 中間～低レイヤー         | フォント描画, グラフィック描画         | フォントやグラフィックの描画処理を担当する部分で、<br>OSの描画API（WindowsのGDI、MacのQuartzなど）やGPUと連携し、効率的に画面に出力する。                                                     |
| ユーザーインターフェース (User Interface) | 高レイヤー             | タブ管理, アドレスバー, ボタン類       | ブラウザの外観や操作部分。<br>ユーザーが直接触れるインターフェースで、アドレスバー、ブックマーク、タブ管理、戻る/進むボタンなどが含まれる。                                                 |

## レンダリングエンジン
### 各要素と処理順
1. HTMLパサー(Parser)
  - HTMLを解析してDOM(Document Object Model)を作成
  - `<script> `を読み込むと、JavaScriptエンジンに処理を渡す
    - この動作は、`defer/async`で管理される

|              | 属性なし       | `defer`       | `async`       |
|---------------|-------------|-------------|---|
| **HTML解析**   | ブロックする   | ブロックしない | ブロックしない |
| **実行タイミング** | 即座に実行   | HTML解析後    | ダウンロード後すぐ |
| **順序**       | 記述順        | 記述順       | 順不同       |
| **用途**       | 小規模/依存あり | DOM操作      | 依存なし      |

2. CSSパサー
  - CSSを解析してCSSOM(CSS Object Model)ツリーを作成
3. レイアウトエンジン
  - DOMツリーとCSSOMツリーを組み合わせて、各要素のサイズ・一を計算
  - レイアウトツリー(Render Tree)を作成
  - `display: none`要素はレイアウトツリーから弾かれる
  - `visibility: hidden`はレイアウトツリーに含まれる
4. ペイントエンジン
  - レイアウトツリーの色・画像等を描画し、実際のピクセルデータの作成
5. コンポジットエンジン
  - 要素をレイヤーごとに合成し、最終的な画面の作成

### 処理効率
- 基本的にコンポジット処理が軽く、ペイント処理が少し重く、レイアウト処理(レイヤーの作り直し)が激重
  - 例: `top`等で位置を動かすより`transform`で位置を動かす方が軽い
- 処理量は同じでも、同一エンジンの処理はまとめて一括でする方が軽い
- 各style, DOM操作の影響範囲

| 変更の種類        | 影響を受ける処理               | style/js例                                |
|------------------|------------------------|--------------------------------|
| DOM構造の変更   | レイアウト・ペイント・コンポジット | innerHTML で要素を追加・変更 |
| サイズ・位置の変更 | レイアウト・ペイント・コンポジット | width, height, margin を変更 |
| スタイルの変更  | ペイント・コンポジットのみ | color, background-color を変更 |
| レイヤー移動    | コンポジットのみ | transform, opacity を変更 |

## JavaScriptエンジン
### 主要コンポーネントと処理順
1. パサー(Parser)
  - コード解析、実行可能な抽象構文木(AST)に変換
2. JITコンパイラ(Just In Time Conpiler)
  - 頻繁に実行されるコードを最適化した上でネイティブコードに変換
3. 実行エンジン(Execution Engine)
  - 実行(メモリ管理, スコープ管理含む)

## WebAPIs構成要素
| 名称 (日本語名 + 英語名)         | 簡単な説明                                                                 |
|--------------------------------|--------------------------------------------------------------------------|
| DOM API                        | HTMLやXMLドキュメントを操作するためのAPI。要素の取得、変更、削除、イベント処理が可能。                          |
| CSSOM API                      | CSSスタイルシートを操作するためのAPI。スタイルの取得・変更だけでなく、アニメーションの計算にも関与。               |
| Fetch API                      | ネットワークリクエストを行うためのAPI。非同期通信やリソース取得、ストリーミングレスポンスの処理が可能。             |
| Geolocation API                | デバイスの現在位置（緯度・経度）を取得するためのAPI。ユーザーの許可が必要。                                     |
| Web Storage API                | `localStorage`や`sessionStorage`を使い、クライアント側でキーと値のペア形式でデータを保存するAPI。               |
| WebSocket API                  | サーバーとのリアルタイム双方向通信を可能にするAPI。HTTPとは異なり、常時接続を維持して通信を行う。                |
| Canvas API                     | 2Dグラフィックスを描画するためのAPI。WebGLを利用すれば3D描画も可能。                                |
| WebRTC API                     | ブラウザ間で音声や映像、データを直接通信するためのAPI。サーバーを介さずにP2Pで通信が可能。                     |
| Notifications API              | デスクトップ通知をブラウザから送信するためのAPI。ユーザーの許可が必要。                                  |
| Service Worker API             | プッシュ通知やオフラインキャッシュを可能にするバックグラウンドスクリプトを操作するAPI。ページを閉じても動作可能。  |
| Device API (例: Battery API)    | バッテリー情報、カメラ、マイク、センサー（加速度・ジャイロ）などデバイス固有の情報や機能にアクセスするAPI。      |

# スレッド
## jsに関係あるもの
| **スレッド名**                  | **主な役割**                                              |
|--------------------------|--------------------------------------------------|
| **メインスレッド (Main Thread)** | JavaScript の実行、イベント処理、DOM 操作、レイアウト、レンダリング |
| **レンダリングスレッド (Rendering Thread)** | CSS の適用、描画処理                              |
| **Web API スレッド (I/O Thread)** | `fetch()`、XHR、ファイル I/O、IndexedDB などの処理  |
| **ワーカースレッド (Worker Thread)** | Web Worker、並列処理、高負荷計算のオフロード         |
| **Service Worker スレッド** | バックグラウンド処理、オフラインキャッシュ、プッシュ通知  |
| **タイマースレッド (Timer Thread)** | `setTimeout()`、`setInterval()` のカウント管理     |
| **ガベージコレクタスレッド (Garbage Collector)** | メモリ管理、不要オブジェクトの自動破棄            |
| **Audio/Graphics Worklet** | 高速オーディオ処理、CSSカスタム描画                  |

## その他
| スレッド名              | 概要                                                                 |
|------------------------|----------------------------------------------------------------------|
| UIスレッド (UI Thread)  | **スクロール**や**クリック操作**、**マウスイベント**など、ユーザーインターフェースの処理を担当。 |
| 動画デコードスレッド      | **動画のデコード**や再生の処理（YouTube などのストリーミング動画用）。                           |
| オーディオスレッド       | **オーディオデータのデコード**や再生を担当（音声エフェクトや BGM 再生など）。                   |
| ネットワークスレッド      | **HTTPリクエスト**やレスポンスを受信し、I/Oスレッドにデータを渡す。                              |
| データストレージスレッド  | **ローカルストレージ**や**IndexedDB** の読み書きを管理。                                        |
| プラグインスレッド        | **ブラウザプラグイン**（例: Flash Player）が動作するスレッド。                                   |
| GPUスレッド             | **GPU（グラフィック処理装置）**を用いた描画やレンダリングを担当。                              |

# トリガー
## 説明
- 特定条件(時間経過、イベント)の監視、及びトリガーを基にした処理(タスクキューへのpush等)は、ブラウザ側のネイティブなコンポーネントによって実行される
- これらはJSだけでは理解不可

## 例
| **担当**                | **コンポーネント名（例）**                        | **主な役割**                         |
|-------------------------|----------------------------------|----------------------------------|
| **JavaScript エンジン**  | V8（Chrome） / SpiderMonkey（Firefox） / JavaScriptCore（Safari） | JS コードの解析・実行 |
| **タイマー管理**        | `Timers API`（Chromium）         | `setTimeout()` / `setInterval()` の監視 |
| **イベント管理**        | `EventTarget API`（Chromium）   | `addEventListener()` の監視 |
| **レンダリング**        | `Blink`（Chromium） / `Gecko`（Firefox） | DOM の描画管理 |
| **ネットワーク**        | `Networking`（Chromium）        | `fetch()` や `WebSocket` のリクエスト管理 |
| **OS システムイベント** | Windows API / macOS API / Linux API | マウス・キーボード・スクロールイベントの取得 |
