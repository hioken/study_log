# ブラウザの構成要素
## 高い抽象度での構成要素
| 名称           | レイヤー               | 代表的な構成要素                  | 説明                                                                                                                                                                 |
|---------------------------------|-----------------------|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| レンダリングエンジン (Rendering Engine) | 中間レイヤー            | HTMLパーサー, CSSパーサー, レイアウト計算, レンダーツリー, コンポジタ | HTML/CSSを解析し、DOMツリーやCSSOMツリーを生成。<br>これらを基にレイアウト計算を行い、画面に描画するためのレンダーツリーを作成。<br>コンポジタで最終描画処理を行う。                        |
| JavaScriptエンジン (V8エンジンなど)    | 中間～低レイヤー         | ECMAScript, Web APIs, イベントループ | JavaScriptコードをコンパイル・実行するエンジン。<br>ECMAScript仕様を実現し、非同期処理を管理するイベントループや、<br>ブラウザ独自のWeb APIsと連携して動作する。                                  |
| ネットワーキング (Networking)         | 中間～低レイヤー         | HTTPリクエスト, TCP/IP通信, SSL/TLS | HTTPリクエストの送信、レスポンス受信、DNS解決、SSL/TLSハンドシェイクなど、通信関連の全般を担当。<br>ブラウザのネットワーク通信の根幹を支えるモジュール。                                        |
| リソースローダー (Resource Loader)      | 中間レイヤー            | リソース取得, キャッシュ処理          | HTMLを解析して発見した外部リソース（CSS、JavaScript、画像など）を効率的に取得し、<br>必要なエンジンに供給する仕組み。依存関係の解決やキャッシュ処理も行う。                                     |
| データストレージ (Data Storage)        | 中間～低レイヤー         | ローカルストレージ, IndexedDB, Cookie | クライアントサイドでデータを永続化する仕組み。ウェブアプリが状態を保存したり、認証情報を保持するために使われる。<br>IndexedDBは大量データに向く高機能なデータベースAPI。                           |
| ブラウザエンジン (Browser Engine)       | 中間レイヤー            | レンダリングエンジン管理, ネットワーク調整 | 各モジュール（レンダリングエンジン、JavaScriptエンジン、ネットワーキングなど）の統括管理を行い、<br>効率的に連携させる役割を果たす。                                                           |
| サンドボックス (Sandbox)               | 高レイヤー～中間レイヤー  | セキュリティポリシー, メモリ隔離      | 各タブやスクリプトを隔離して実行し、セキュリティを確保する仕組み。<br>クロスオリジン制限（CORS）や、不正なコードからのデータ保護を行う。                                                       |
| プロセスマネージャ (Process Manager)      | 高レイヤー～中間レイヤー  | プロセス分離, タブ間通信            | 各タブを独立したプロセスとして動作させる仕組み。<br>リソース分配やタブ間通信の調整、クラッシュ時の復元も担当する。                                                                         |
| メモリ管理 (Memory Manager)           | 中間～低レイヤー         | ガベージコレクション, ヒープ管理       | JavaScriptエンジンやレンダリングエンジンで利用されるメモリを効率的に管理。<br>特にJavaScriptではガベージコレクションを通じて不要なメモリを解放する仕組みが重要。                                     |
| UIバックエンド (UI Backend)            | 中間～低レイヤー         | フォント描画, グラフィック描画         | フォントやグラフィックの描画処理を担当する部分で、<br>OSの描画API（WindowsのGDI、MacのQuartzなど）やGPUと連携し、効率的に画面に出力する。                                                     |
| ユーザーインターフェース (User Interface) | 高レイヤー             | タブ管理, アドレスバー, ボタン類       | ブラウザの外観や操作部分。<br>ユーザーが直接触れるインターフェースで、アドレスバー、ブックマーク、タブ管理、戻る/進むボタンなどが含まれる。                                                 |

## WebAPIs構成要素
| 名称 (日本語名 + 英語名)         | 簡単な説明                                                                 |
|--------------------------------|--------------------------------------------------------------------------|
| DOM API                        | HTMLやXMLドキュメントを操作するためのAPI。要素の取得、変更、削除が可能。                                |
| CSSOM API                      | CSSスタイルシートを操作するためのAPI。スタイルの取得、変更が可能。                                        |
| Fetch API                      | ネットワークリクエストを行うためのAPI。非同期通信やリソース取得を簡単に実現する。                          |
| Geolocation API                | デバイスの現在位置（緯度・経度）を取得するためのAPI。                                                    |
| Web Storage API                | `localStorage`や`sessionStorage`を使い、クライアント側でデータを保存するためのAPI。                        |
| WebSocket API                  | サーバーとのリアルタイム双方向通信を可能にするAPI。                                                      |
| Canvas API                     | 2Dグラフィックスを描画するためのAPI。ゲームやデータビジュアライゼーションに使用される。                        |
| WebRTC API                     | ブラウザ間で音声や映像、データを直接通信するためのAPI。                                                    |
| Notifications API              | デスクトップ通知をブラウザから送信するためのAPI。                                                        |
| Service Worker API             | プッシュ通知やオフラインキャッシュを可能にするバックグラウンドスクリプトを操作するAPI。                        |
| Device API (例: Battery API)    | バッテリー情報、カメラ、マイクなどデバイス固有の情報や機能にアクセスするためのAPI。                            |


# Js
## レスポンスの読み込み順
1. **HTMLパーサー**が動き、HTMLを解析して**DOMツリー**を構築する。  
2. **CSSパーサー**が動き、CSSを解析して**スタイルルール**を適用し、**スタイルツリー**を構築する。  
3. **`<script>`タグ**に遭遇した場合：  
   - **通常:** HTMLパーサーは中断し、**JavaScriptエンジン**が即座に実行する。  
   - **defer:** HTMLパーサーは中断せず解析を続け、HTMLの解析が完了した後にJavaScriptエンジンが実行する。  
   - **async:** JavaScriptは並行してダウンロードされ、ダウンロード後即座に実行される（HTMLパーサーは一時中断）。  
4. **HTMLの解析が完了:**  
   - `defer`付きスクリプトが**順番通り**に実行される。  
5. **CSSエンジン**がスタイルを適用し、**レンダリングエンジン**が画面描画を行う。  
6. **JavaScriptエンジン**はイベントリスナーや非同期処理（例: `fetch`）が発火するたびに再度動き出す。  
7. ページが完全に表示された後も、JavaScriptエンジンは**ユーザー操作や非同期リクエスト**で動き続ける。


|              | 属性なし       | `defer`       | `async`       |
|---------------|-------------|-------------|---|
| **HTML解析**   | ブロックする   | ブロックしない | ブロックしない |
| **実行タイミング** | 即座に実行   | HTML解析後    | ダウンロード後すぐ |
| **順序**       | 記述順        | 記述順       | 順不同       |
| **用途**       | 小規模/依存あり | DOM操作      | 依存なし      |

## ブラウザ上でのグローバルオブジェクト
### Web APIsとグローバルオブジェクト
- **Web APIsとグローバルオブジェクトの関係**:
  - Web APIsは、ブラウザが提供する機能（例: DOM, Fetch API, WebSocket）を指す。
  - Web APIsはグローバルオブジェクト（ブラウザでは`window`）にプロパティとして登録される。

- **ブラウザ環境のプロセス**:
  1. ブラウザがグローバルオブジェクト（`window`）を作成。
  2. Web APIsを`window`に登録（例: `window.document`, `window.fetch`）。
  3. JavaScriptエンジン（例: V8）が`window`を利用してスクリプトを実行。

- **例: グローバルオブジェクトとWeb APIs**
```javascript
console.log(window.document); // DOM API
console.log(window.fetch);    // Fetch API
console.log(window.setTimeout); // Timer API
```

