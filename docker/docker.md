# 基礎知識
## 概要
### Dockerの全体構成
Dockerは、アプリケーションをコンテナとして動作させる仮想化技術。以下の構成要素が層の低い順に並ぶ。
1. **ホストOS**  
   DockerはホストOS上で動作する。Linuxが多く使われるが、WindowsやmacOSでも動作可能。  
   特にLinuxではKernelがNamespaceやCgroupを活用し、コンテナの基盤を提供する。
2. **Docker Daemon**  
   ホストOS上で動作する常駐プロセス。イメージの管理、コンテナの作成・実行、ネットワークの設定などを統括。  
   CLIツール（`docker`コマンド）から受け取った指示を処理する役割も担う。
3. **イメージ**  
   コンテナの設計図。アプリケーションのコード、依存関係、ライブラリ、実行環境をパッケージ化したもの。  
   Dockerfileを元にビルドされ、分割された差分レイヤーとして管理される。
4. **コンテナ**  
   イメージから生成される実行環境の実体。隔離されたプロセス空間で動作し、ホストOS上で複数のコンテナを並行して実行可能。

### NamespaceとCgroup
Dockerの基盤となるLinux Kernelの機能で、コンテナの分離とリソース管理を実現。
- **Namespace**  
  プロセスやネットワークなどの分離を提供し、コンテナ間の独立性を確保する。  
  - **PID Namespace**: プロセスIDの分離。コンテナ内でホストとは別のPID空間を利用。  
  - **NET Namespace**: ネットワークスタックの分離。コンテナごとに独立したIPやポート空間を利用可能。  
  - **MNT Namespace**: ファイルシステムの分離。コンテナごとに独立したマウントポイントを設定できる。
- **Cgroup**  
  リソースの制限と管理を提供する仕組み。ホストOSのリソース（CPU、メモリ、ディスクI/O）をコンテナごとに制御可能。  
  - CPU: 使用量の上限を`--cpus`で指定する。  
  - メモリ: メモリ使用量を`--memory`で制限する。  
  - I/O: ディスクの読み書き速度を`--device-read-bps`や`--device-write-bps`で制御する。

### イメージの仕組み
Dockerイメージは、効率的なストレージ管理と再利用性を実現するレイヤー構造で構成される。
- **レイヤー構造**  
  イメージは複数の差分レイヤーで構成される。新しい命令（RUN、COPYなど）が追加されるたびにレイヤーが生成され、既存レイヤーを再利用することでビルド時間やストレージを節約する。  
  各レイヤーは不変（immutable）で、変更があれば新しいレイヤーが作成される。

# コンテナ単体
## ファイル共有方法
### Volume
Volumeは、Dockerが管理する永続化ストレージを提供する仕組み。コンテナ間でデータを共有したり、コンテナ停止後もデータを保持する用途に使われる。
- **作成**: `docker volume create ボリューム名`で新しいボリュームを作成。名前を指定しない場合は自動生成される。  
- **確認**: `docker volume ls`で既存ボリュームの一覧を表示。`docker volume inspect ボリューム名`で詳細を確認可能。  
- **削除**: `docker volume rm ボリューム名`で不要なボリュームを削除。利用中のボリュームは削除できない。  
### Bind Mount
Bind Mountは、ホスト側の特定ディレクトリをコンテナ内に直接マウントする方法。開発環境でのホットリロードやデバッグに便利。
- **設定**: コンテナ起動時に`-v`または`--mount`オプションを使用し、ホストディレクトリとコンテナ内のパスを指定。  
  例: `docker run -v /path/on/host:/path/in/container イメージ名`  
- **注意点**: ホスト側のディレクトリに対するアクセス権限がコンテナにも反映されるため、適切な権限設定が必要。セキュリティリスクを伴う場合があるため、プロダクション環境では使用を控える。

## リソース制御
### CPU・メモリ制限
- **CPU制限**:  
  コンテナに割り当てるCPUコア数を制限する。  
  - `--cpus`で割り当て可能なCPU時間の割合を指定。例: `--cpus=1.5`は1.5コア分を利用可能。  
  - 制限を設定しない場合、コンテナはホスト全体のCPUリソースを使用可能。  

- **メモリ制限**:  
  コンテナが利用できるメモリの上限を設定する。  
  - `--memory`で最大メモリサイズをバイト単位で指定。例: `--memory=512m`。  
  - `--memory-swap`を併用すると、メモリ不足時のスワップ領域を制御可能。
### I/O制限
- **ディスクI/O制御**:  
  コンテナごとのディスク読み書き速度を制御可能。  
  - `--device-read-bps`で読み込み速度を指定。例: `--device-read-bps=/dev/sda:1mb`は/dev/sdaの読み込み速度を1MB/sに制限。  
  - `--device-write-bps`で書き込み速度を制限可能。

## ログの確認
### ログ取得方法
- `docker logs コンテナ名`で標準出力とエラー出力を取得。  
- ログの確認は、デバッグやアプリケーション動作確認に必要不可欠。
### リアルタイム監視
- `docker logs -f コンテナ名`でリアルタイムにログを監視。終了しないプロセスの動作確認やエラー解析に有効。
### ログファイルの保管方法やローテーション設定
- **ログの保管先**: デフォルトでは、コンテナの標準出力とエラー出力が`json-file`ドライバーで保存される。  
- **ローテーション**: ログサイズが増大しすぎるのを防ぐため、`--log-opt`オプションで設定可能。  
  - 例: `--log-opt max-size=10m`で最大10MBに制限し、古いログを削除。  
### 外部ファイルへのログ出力
- **設定**: コンテナ起動時に`--log-driver`を指定し、外部ログシステムに出力を送る。  
  - syslog: `--log-driver=syslog`でシステムログに送信可能。  
  - json-file: ログをJSON形式で保存（デフォルト）。  
- **例**:  
  ```bash
  docker run --log-driver=syslog --log-opt syslog-address=tcp://192.168.0.1:514 イメージ名
  ```

## セキュリティ
勉強する際に調べるべきポイントの一覧
- **Rootlessモード**: 非特権ユーザーでのコンテナ実行。  
- **脆弱性チェック**: `docker scan`、Trivyなどのツール。  
- **コンテナ間の通信制限**: ネットワークポリシーの設定方法。  
- **イメージセキュリティ**: イメージ署名や信頼モデル（Docker Content Trust）。

# コンテナ統合
## Network
### ネットワークの種類
- **デフォルトネットワーク**  
  Dockerが自動で作成するネットワークタイプ。主に以下の3種類が存在する。  
  - **bridge**: コンテナ間通信を可能にするプライベートネットワーク。コンテナはbridgeネットワークを通じて相互に通信可能で、ホストからもアクセス可能。デフォルトで使用される。  
  - **host**: コンテナがホストマシンのネットワークスタックを直接使用する。ポートマッピングが不要。パフォーマンス向上が目的だが、セキュリティ上のリスクがある。  
  - **none**: ネットワークを無効化。コンテナにネットワークインターフェイスを割り当てない。ネットワークを完全にカスタマイズしたい場合に利用。
- **Overlayネットワーク**  
  複数ホスト間でのコンテナ通信を可能にするネットワーク。Docker SwarmやKubernetesで使用される。仮想ネットワークを作成し、異なるホスト上のコンテナが同じネットワークを共有できる。  
  - 主にマイクロサービスや分散システムでの利用に適している。
- **macvlanネットワーク**  
  コンテナにホストと同じネットワーク上の独立したMACアドレスを割り当てる。コンテナを物理マシンと同等のネットワークデバイスとして動作させることができる。  
  - 主にネットワークトポロジーの要件が厳しい場合や、レガシーシステムとの統合に利用される。

### 通信の確認
- **ネットワーク構造の調査**  
  `docker network inspect ネットワーク名`でネットワークの詳細情報を取得可能。コンテナ間の接続状況や割り当てられたIPアドレスを確認できる。
- **名前解決の仕組み**  
  Dockerは内部DNSを提供し、コンテナ間通信で名前解決を可能にする。  
  - **エイリアス設定**: `docker-compose.yml`で`networks.aliases`を使用すると、サービス名以外のエイリアス名で通信可能。  
    - ネットワークスコープでエイリアスを設定でき、ネットワークごとに異なる名前を持たせることが可能。  
  - **container_nameとの違い**:  
    - `container_name`を設定しても名前解決は可能だが、他の目的（コンテナ名の固定やホストレベルのアクセス）も含むため、名前解決だけが目的なら`networks.aliases`が最適。  
    - `container_name`はホスト全体でユニークな名前が必要だが、`networks.aliases`はネットワーク内での名前解決に特化しており、柔軟性が高い。

## ログ管理
### Composeのログ取得
- **複数サービスのログを確認**  
  `docker-compose logs`を使用すると、すべてのサービスのログを一括で確認可能。マイクロサービスアーキテクチャでのデバッグに役立つ。
- **特定のサービスログの取得**  
  `docker-compose logs サービス名`で、特定のサービスに絞ったログを取得可能。関係のないログを排除して効率的に問題箇所を特定できる。

# 立ち上げ
## Dockerfile
### 書き方や仕様
- **基本構文**  
  Dockerfileは、コンテナイメージをビルドするための手順を記述したファイル。以下が主な構文とその用途。  
  - `FROM`: ベースイメージを指定。例: `FROM ubuntu:20.04`  
  - `RUN`: コンテナ内で実行するコマンドを指定し、成果物をイメージに反映する。例: `RUN apt-get update && apt-get install -y curl`  
  - `COPY`: ホストからコンテナにファイルをコピー。例: `COPY ./app /app`  
  - `CMD`: コンテナ起動時に実行するデフォルトコマンド。例: `CMD ["python", "app.py"]`  
  - `ENV`: 環境変数を設定。例: `ENV APP_ENV=production`  
  - `ARG`: ビルド時に使用する引数を定義。例: `ARG VERSION=1.0`
- **キャッシュ効率を意識した命令順序**  
  Dockerfileの命令はキャッシュ可能で、順序が効率に影響を与える。  
  - 頻繁に変更される命令（例: `COPY`や`RUN`でアプリケーションコードを追加する部分）は後方に配置。  
  - ベースイメージの指定や依存関係のインストールなど、変更が少ない部分を先頭に配置。
- **マルチステージビルド**  
  複数の`FROM`ステートメントを使用し、ビルド用環境と実行環境を分離。不要なファイルや依存関係を除去し、軽量な最終イメージを作成可能。  
  - 例:  
    ```dockerfile
    FROM golang:1.18 as builder
    WORKDIR /app
    COPY . .
    RUN go build -o myapp

    FROM alpine:latest
    WORKDIR /app
    COPY --from=builder /app/myapp .
    CMD ["./myapp"]
    ```

## Docker Compose
### 構成
- **docker-compose.ymlでのサービス間連携**  
  `docker-compose.yml`を使用して複数のサービスを定義し、連携させる。各サービスは独立したコンテナとして起動されるが、Composeで設定されたネットワークを介して通信可能。  
  - 例:  
    ```yaml
    version: "3.9"
    services:
      web:
        image: nginx
        ports:
          - "8080:80"
      app:
        build:
          context: .
        depends_on:
          - db
      db:
        image: postgres
    ```

- **ネットワーク・ボリューム・環境変数の設定**  
  `docker-compose.yml`で以下の設定が可能。  
  - **ネットワーク**: サービスごとにネットワークを指定可能。  
    ```yaml
    networks:
      default:
        driver: bridge
    ```  
  - **ボリューム**: 永続化ストレージをサービスに関連付ける。  
    ```yaml
    volumes:
      db_data:
    services:
      db:
        volumes:
          - db_data:/var/lib/postgresql/data
    ```  
  - **環境変数**: 環境に依存した設定を変数として分離可能。  
    ```yaml
    environment:
      - APP_ENV=production
      - DEBUG=false
    ```

# 環境整備
## 環境確認チェックリスト
### コンテナ
- **起動中/停止中コンテナの確認**  
  `docker ps -a`で現在のコンテナの一覧を表示。  
  - **STATUS列**: 起動中（`Up`）や停止中（`Exited`）など、各コンテナの状態が確認できる。  
  - **IDと名前**: 各コンテナには一意のコンテナIDとわかりやすい名前が付与される。操作時に使用。
- **不要なコンテナの削除**  
  `docker rm コンテナ名`で不要なコンテナを削除可能。  
  - **一括削除**: 複数のコンテナを削除する場合、スペース区切りで複数指定可能。  
    例: `docker rm コンテナ1 コンテナ2`  
  - **強制削除**: 実行中のコンテナを削除する場合は`docker rm -f`で強制削除する。
### ボリューム
- **現在のボリューム確認**  
  `docker volume ls`で現在存在するボリュームの一覧を表示。  
  - **ボリューム名**: ホストとコンテナで共有するデータストアの識別子。  
  - **DRIVER列**: 使用されているボリュームドライバーを確認できる（通常は`local`）。
- **不要なボリュームの削除**  
  `docker volume rm ボリューム名`で不要なボリュームを削除。  
  - **注意点**: ボリュームが利用中の場合は削除できない。関連するコンテナを削除する必要がある。
### イメージ
- **利用可能なイメージの確認**  
  `docker images`で現在のイメージ一覧を確認可能。  
  - **REPOSITORY**: イメージが属するプロジェクト名。  
  - **TAG**: イメージのバージョン識別子（例: `latest`）。  
  - **IMAGE ID**: イメージのユニークな識別子。削除や操作に使用。

- **キャッシュ削除とメンテナンス**  
  `docker image prune`で未使用のイメージを削除。  
  - **対象**: 他のコンテナやイメージに参照されていない不要なキャッシュのみが削除される。  
  - **確認フラグ**: `-f`オプションで確認プロンプトを省略可能。
### ネットワーク
- **現在のネットワーク一覧**  
  `docker network ls`で作成済みネットワークの一覧を表示。  
  - **NETWORK ID**: 各ネットワークのユニークな識別子。  
  - **DRIVER**: ネットワークタイプ（例: `bridge`, `host`, `overlay`など）。
- **不要なネットワーク削除**  
  `docker network prune`で未使用のネットワークを一括削除。  
  - **対象**: 現在のコンテナが使用していないネットワークのみが削除対象となる。
### ストレージ全体
- **環境全体をクリーンアップ**  
  `docker system prune`で未使用のリソース（停止中コンテナ、未使用イメージ、ネットワーク）を一括削除。  
  - **ボリュームを残す**: `--volumes`オプションを指定しない場合、ボリュームは削除されない。  
  - **確認フラグ**: `-f`オプションで確認プロンプトをスキップ可能。


# DockerコマンドとCompose設定リファレンス
## Dockerコマンドのジャンル別詳細まとめ

| **ジャンル**        | **コマンド**                                     | **説明**                                                                                   | **主要オプション**                                                                       |
|---------------------|-------------------------------------------------|-------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| **イメージ関連**    | `docker images`                                 | 利用可能なイメージの一覧を表示。                                                          | `-q`（イメージIDのみ出力）                                                              |
|                     | `docker pull イメージ名`                        | イメージをリポジトリから取得。                                                             |                                                                                         |
|                     | `docker build -t イメージ名 .`                  | Dockerfileからイメージをビルド。                                                           | `--no-cache`（キャッシュを使用せずビルド）                                              |
|                     | `docker image rm イメージ名`                    | 不要なイメージを削除。                                                                     |                                                                                         |
|                     | `docker image prune`                            | 未使用イメージを一括削除。                                                                 | `-a`（すべての未使用イメージ削除）                                                      |
| **コンテナ関連**    | `docker ps`                                     | 起動中のコンテナ一覧を表示。                                                               | `-q`（コンテナIDのみ出力）、`-f`（フィルタリング）                                       |
|                     | `docker ps -a`                                  | すべてのコンテナ（停止中含む）の一覧を表示。                                               |                                                                                         |
|                     | `docker run イメージ名`                         | 指定したイメージからコンテナを起動。                                                       | `-d`（バックグラウンド実行）、`-it`（対話モード）                                        |
|                     | `docker start コンテナ名`                       | 停止中のコンテナを再起動。                                                                 |                                                                                         |
|                     | `docker stop コンテナ名`                        | コンテナを停止。                                                                           |                                                                                         |
|                     | `docker rm コンテナ名`                          | コンテナを削除。                                                                           | `-f`（強制削除）                                                                         |
|                     | `docker exec -it コンテナ名 コマンド`           | 実行中のコンテナ内でコマンドを実行。                                                       |                                                                                         |
|                     | `docker logs コンテナ名`                        | コンテナのログを取得。                                                                     | `-f`（リアルタイム監視）、`--tail n`（最後のn行のみ出力）                                |
| **ネットワーク関連** | `docker network ls`                             | 作成済みネットワークの一覧を表示。                                                         |                                                                                         |
|                     | `docker network create ネットワーク名`          | 新しいネットワークを作成。                                                                 |                                                                                         |
|                     | `docker network connect ネットワーク名 コンテナ名` | コンテナをネットワークに接続。                                                             |                                                                                         |
|                     | `docker network disconnect ネットワーク名 コンテナ名` | コンテナをネットワークから切断。                                                           |                                                                                         |
|                     | `docker network inspect ネットワーク名`         | ネットワークの詳細情報を確認。                                                             |                                                                                         |
|                     | `docker network rm ネットワーク名`              | ネットワークを削除。                                                                       |                                                                                         |
| **ストレージ関連**   | `docker volume ls`                              | 作成済みボリュームの一覧を表示。                                                           |                                                                                         |
|                     | `docker volume create ボリューム名`             | 新しいボリュームを作成。                                                                   |                                                                                         |
|                     | `docker volume rm ボリューム名`                 | ボリュームを削除。                                                                         |                                                                                         |
|                     | `docker system prune --volumes`                 | ボリュームを含めた未使用リソースを一括削除。                                               |                                                                                         |
| **システム全体**    | `docker info`                                   | Dockerのシステム情報を表示。                                                              |                                                                                         |
|                     | `docker stats`                                  | 実行中のコンテナのリソース使用状況を監視。                                                 | `-a`（すべてのコンテナを監視）                                                          |

## docker-compose.ymlで書けることの詳細まとめ

| **セクション**      | **階層/オプション**                  | **説明**                                                                                   |
|---------------------|------------------------------------|-------------------------------------------------------------------------------------------|
| **version**         | `version: "3.9"`                  | Composeファイルのバージョンを指定。                                                        |
| **services**        | `services: サービス名:`            | 各サービス（コンテナ）の定義を記述。                                                       |
| **build**           | `build: context: .`               | Dockerfileのあるディレクトリを指定。                                                       |
|                     | `build: dockerfile: Dockerfile`   | 使用するDockerfileを指定。                                                                 |
| **image**           | `image: nginx:latest`             | 使用するイメージを指定。                                                                   |
| **ports**           | `ports: - "8080:80"`              | ホストとコンテナのポートをマッピング。                                                     |
| **volumes**         | `volumes: - ./data:/var/lib/data` | ホストとコンテナ間で共有するストレージを指定。                                              |
| **networks**        | `networks: - default`             | ネットワークを指定してサービスを接続。                                                     |
| **environment**     | `environment: - APP_ENV=production` | 環境変数を指定。                                                                           |
| **depends_on**      | `depends_on: - db`                | 他のサービスに依存する関係を設定。                                                         |
|                     | `condition: - option`                | service_started or service_helthy                                                         |
| **command**         | `command: python app.py`          | コンテナ起動時に実行するコマンドを指定。                                                   |
| **restart**         | `restart: always`                 | 再起動ポリシーを指定（例: `always`, `on-failure`など）。                                    |
| **deploy**          | `deploy: replicas: 3`             | スケーリング設定（Swarmモードで使用）。                                                    |
| **healthcheck**     | `healthcheck: test: ["CMD", "curl", "-f", "http://localhost"]` | ヘルスチェックコマンドを指定し、サービスの状態を監視。                                      |
| **secrets**         | `secrets: - my_secret`            | 機密データ（例: パスワード）の管理（Swarmモードで使用）。                                   |

